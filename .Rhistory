rm(list = ls())      # clear memory (removes all the variables from the workspace)
if (!require('pacman')) install.packages('pacman'); library(pacman) # use this package to conveniently install other packages
# load (install if required) packages from CRAN
p_load("diagram")
# no functions required
# Strategy names
v_names_str <- c("Base Case", "Pill + Inducer", "Pill + Inhibitor")
# Number of strategies
n_str <- length(v_names_str)
# Markov model parameters
v_n  <- c("Initial", "Birth", "Induced abortion",         # state names- 9 states
"Spontanous abortion", "Ectopic pregnancy",
"VTE", "MI", "Stroke", "IMB")
n_states  <- length(v_n)                                  # number of states
n_t  <- 29                                # number of cycles for reproductive age group 15-44 years
#Probability of unintended pregnancy (UP)
p_up_pill <- 0.0111             # probability of unintended pregnancy (UP) with pill alone
p_up_pill_inducer <- 0.0156     # probability of UP with pill + enzyme inducer
p_up_pill_inhibitor <- 0.0082   # probability of UP with pill + enzyme inhibitor
# Conditional probability of Unintended pregnancy outcomes
# These sum to 1
# @MS here I would say, "Probability of birth given you ahve an"
p_birth <- 0.3663               # probability of birth
p_inducedabortion <- 0.4554     # probability of induced abortion
p_spontaneousabortion <- 0.1683 # probability of spontaneous abortion
p_ectopicpregnancy <- 0.01      # probability of ectopic pregnancy
# Unintended pregnancy outcomes by Strategy
# These outcomes are probability of having an unintended pregnancy, given that you were on
# one of the three strategies (do not sum to 1)
## Unintended pregnancy outcomes Strategy 1 - Pill only group
p_birth_pill <- p_up_pill * p_birth
p_inducedabortion_pill <- p_up_pill * p_inducedabortion
p_spontaneousbaortion_pill <- p_up_pill * p_spontaneousabortion
p_ectopicpregnancy_pill <- p_up_pill * p_ectopicpregnancy
## Unintended pregnancy outcomes Strategy 2 - Pill + enzyme inducer group
p_birth_pill_inducer <- p_up_pill_inducer * p_birth
p_inducedabortion_pill_inducer <- p_up_pill_inducer * p_inducedabortion
p_spontaneousbaortion_pill_inducer <- p_up_pill_inducer * p_spontaneousabortion
p_ectopicpregnancy_pill_inducer <- p_up_pill_inducer * p_ectopicpregnancy
## Unintended pregnancy outcomes Strategy 3 - Pill + enzyme inhibitor group
p_birth_pill_inhibitor <- p_up_pill_inhibitor * p_birth
p_inducedabortion_pill_inhibitor <- p_up_pill_inhibitor * p_inducedabortion
p_spontaneousbaortion_pill_inhibitor <- p_up_pill_inhibitor * p_spontaneousabortion
p_ectopicpregnancy_pill_inhibitor <- p_up_pill_inhibitor * p_ectopicpregnancy
## Probability of adverse event outcomes
p_vte <- 0.001
p_mi <- 0.000205
p_stroke <- 0.00037026
p_imb <- 0.005
## Probability of adverse event outcomes by strategy
## Probability of adverse event outcomes Strategy 1 - Pill
p_vte_pill <- p_vte
p_mi_pill <- p_mi
p_stroke_pill <- p_stroke
p_imb_pill <- p_imb
## Probability of adverse event outcomes Strategy 2 - Pill + enzyme inducer
p_vte_pill_inducer <- p_vte
p_mi_pill_inducer <- p_mi
p_stroke_pill_inducer <- p_stroke
p_imb_pill_inducer <- 0.07
## Probability of adverse event outcomes Strategy 3 - Pill + enzyme inhibitor
p_vte_pill_inhibitor <- p_vte + 0.2 * p_vte
p_mi_pill_inhibitor <- p_mi
p_stroke_pill_inhibitor <- p_stroke
p_imb_pill_inhibitor <- p_imb
# Costs of initial state for three strategies
c_pill  <- 680          # cost of remaining in pill only group
c_pill_inducer <- 340   # cost of remaining in pill + enzyme inducer group (conservative)
c_pill_inhibitor <-340  # cost of remaining in pill + enzyme inhibitor group (conservative)
# Cost of birth outcomes
c_birth  <- 13252              # cost of remaining one cycle sick
c_inducedabortion  <- 931      # cost of remaining one cycle dead
c_spontaneousabortion <- 1141  # cost of spontaneous abortion
c_ectopicpregnancy <- 6174     # cost of ectopic pregnancy
# cost of adverse event outcomes
c_vte <- 14305                # cost of venous thromboembolism
c_mi <- 23528                 # cost of myocardial infarction
c_stroke <- 28979             # cost of stroke
c_imb <- 50                   # cost of intermenstrual bleeding (conservative)
# Utility values
## Utility of initial state for three strategies
u_pill  <-  1                 # Assuming perfect health on pill alone
u_pill_inducer <- 0.95        # Lowered utility because of condition that requires drug (epilepsy, HIV etc)
u_pill_inhibitor <- 0.95      # Lowered utility because of condition that requires drug (epilepsy, HIV etc)
u_birth  <-  0.9064              # Utility of birth
u_inducedabortion  <- 0.9615     # Utility of abortion
u_spontaneousabortion <- 0.9423  # Utility of spontaneous abortion
u_ectopicpregnancy <- 0.91667    # Utility of ectopic pregnancy
u_vte <- 0.81                   # Utility of VTE
u_mi <- 0.67                    # Utility of MI
u_stroke <- 0.33                # Utility of Stroke
u_imb <- 0.78                   # Utility of Inter menstrual bleeding
d_e <- d_c <- 0.03                      # equal discount of costs and QALYs by 3%
# calculate discount weights for costs for each cycle based on discount rate d_c
v_dwc <- 1 / (1 + d_e) ^ (0:n_t)
# calculate discount weights for effectiveness for each cycle based on discount rate d_e
v_dwe <- 1 / (1 + d_c) ^ (0:n_t)
m_P_diag_pill <- matrix(0, nrow = n_states, ncol = n_states, dimnames = list(v_n, v_n))
m_P_diag_pill["Initial", "Initial" ]  = ""
m_P_diag_pill["Initial", "Birth" ]  = ""
m_P_diag_pill["Initial", "Induced abortion" ]  = ""
m_P_diag_pill["Initial", "Spontanous abortion" ]  = ""
m_P_diag_pill["Initial", "Ectopic pregnancy" ]  = ""
m_P_diag_pill["Initial", "VTE" ]  = ""
m_P_diag_pill["Initial", "MI" ]  = ""
m_P_diag_pill["Initial", "Stroke" ]  = ""
m_P_diag_pill["Initial", "IMB" ]  = ""
m_P_diag_pill["IMB", "Initial" ]  = ""
layout.fig <- c(1,4,4)
st_tr_diag_pill <- plotmat(t(m_P_diag_pill), t(layout.fig), self.cex = 0.5, curve = 0, arr.pos = 0.8,
latex = T, arr.type = "curved", relsize = 0.85, box.prop = 0.8,
cex = 0.8, box.cex = 0.7, lwd = 1)
# create the cohort trace
m_M_pill <- matrix(NA,
nrow = n_t + 1 ,  # create Markov trace (n.t + 1 because R doesn't
# understand Cycle 0)
ncol = n_states,
dimnames = list(0:n_t, v_n))
m_M_pill[1, ] <- c(1,0,0,0,0,0,0,0,0)          # initialize first cycle of Markov trace
# create the transition probability matrix
m_P_pill  <- matrix(0,
nrow = n_states, ncol = n_states,
dimnames = list(v_n, v_n)) # name the columns and rows of the transition
# probability matrix
m_P_pill
for (t in 1:n_t){                   # loop through the number of cycles
m_M_pill[t + 1, ] <- m_M_pill[t, ] %*% m_P_pill  # estimate the state vector for the next cycle (t + 1)
}
